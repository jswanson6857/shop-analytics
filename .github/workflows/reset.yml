name: Reset AWS (Delete Everything)

on:
  workflow_dispatch:

jobs:
  reset:
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Delete All Resources
        run: |
          # Delete in correct order (reverse of dependencies)
          
          # Lambdas
          for func in sync-tekmetric api-ros api-contact api-users api-analytics batch-appointments batch-sales; do
            aws lambda delete-function --function-name "revivecrm-${func}-prod" 2>/dev/null || true
          done
          
          # API Gateway
          API_ID=$(aws apigateway get-rest-apis --query "items[?name=='revivecrm-api-prod'].id" --output text)
          [ -n "$API_ID" ] && aws apigateway delete-rest-api --rest-api-id "$API_ID" || true
          
          # EventBridge
          for rule in batch-appointments batch-sales; do
            aws events remove-targets --rule "revivecrm-${rule}-prod" --ids "1" 2>/dev/null || true
            aws events delete-rule --name "revivecrm-${rule}-prod" 2>/dev/null || true
          done
          
          # CloudWatch Logs
          for func in sync-tekmetric api-ros api-contact api-users api-analytics batch-appointments batch-sales; do
            aws logs delete-log-group --log-group-name "/aws/lambda/revivecrm-${func}-prod" 2>/dev/null || true
          done
          
          # DynamoDB Tables
          for table in repair-orders contact-history appointments sales-tracking settings analytics-cache; do
            aws dynamodb delete-table --table-name "revivecrm-${table}-prod" 2>/dev/null || true
          done
          
          # Wait for tables to delete
          sleep 30
          
          # IAM Roles (detach policies first)
          for role in lambda-exec eventbridge-exec; do
            ROLE_NAME="revivecrm-${role}-prod"
            
            # Detach managed policies
            aws iam list-attached-role-policies --role-name "$ROLE_NAME" --query 'AttachedPolicies[].PolicyArn' --output text 2>/dev/null | \
              xargs -n1 -I{} aws iam detach-role-policy --role-name "$ROLE_NAME" --policy-arn {} 2>/dev/null || true
            
            # Delete inline policies
            aws iam list-role-policies --role-name "$ROLE_NAME" --query 'PolicyNames[]' --output text 2>/dev/null | \
              xargs -n1 -I{} aws iam delete-role-policy --role-name "$ROLE_NAME" --policy-name {} 2>/dev/null || true
            
            # Delete role
            aws iam delete-role --role-name "$ROLE_NAME" 2>/dev/null || true
          done
          
          # Secrets Manager
          aws secretsmanager delete-secret --secret-id revivecrm-prod-tekmetric-credentials --force-delete-without-recovery 2>/dev/null || true
          
          # S3 Frontend Bucket
          aws s3 rm s3://revivecrm-frontend-prod --recursive 2>/dev/null || true
          aws s3api delete-bucket --bucket revivecrm-frontend-prod 2>/dev/null || true
          
          # CloudFront (if exists - note down ID first)
          echo "Note: CloudFront distribution must be disabled manually if it exists"
          echo "This takes 15+ minutes and can't be automated easily"
          
          echo "âœ… All resources deleted! Now run 'Deploy ReviveCRM' workflow."
