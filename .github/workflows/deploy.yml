name: Deploy ReviveCRM

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Terraform Init
        working-directory: terraform
        run: terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Terraform Apply
        working-directory: terraform
        run: |
          # Try to apply, if resources exist, continue anyway
          terraform apply -auto-approve -refresh=true || {
            echo "Some resources may already exist - trying targeted apply for missing resources only"
            terraform apply -auto-approve -refresh=true -target=aws_lambda_function.sync_tekmetric || true
            terraform apply -auto-approve -refresh=true -target=aws_lambda_function.api_ros || true
            terraform apply -auto-approve -refresh=true -target=aws_lambda_function.api_contact || true
            terraform apply -auto-approve -refresh=true -target=aws_lambda_function.api_users || true
            terraform apply -auto-approve -refresh=true -target=aws_lambda_function.api_analytics || true
            terraform apply -auto-approve -refresh=true -target=aws_lambda_function.batch_appointments || true
            terraform apply -auto-approve -refresh=true -target=aws_lambda_function.batch_sales || true
            terraform apply -auto-approve -refresh=true
          }
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_project_name: revivecrm
          TF_VAR_environment: prod
          TF_VAR_aws_region: us-east-1
          TF_VAR_tekmetric_client_id: ${{ secrets.TEKMETRIC_CLIENT_ID }}
          TF_VAR_tekmetric_client_secret: ${{ secrets.TEKMETRIC_CLIENT_SECRET }}
          TF_VAR_tekmetric_shop_id: ${{ secrets.TEKMETRIC_SHOP_ID }}
          TF_VAR_auth0_domain: ${{ secrets.OKTA_ISSUER }}
          TF_VAR_auth0_client_id: ${{ secrets.OKTA_CLIENT_ID }}
      
      - name: Build Frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build
        env:
          REACT_APP_API_URL: ${{ steps.terraform.outputs.api_url }}
      
      - name: Deploy Frontend
        run: |
          BUCKET=$(cd terraform && terraform output -raw s3_bucket_name)
          aws s3 sync frontend/build/ s3://$BUCKET/ --delete
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
