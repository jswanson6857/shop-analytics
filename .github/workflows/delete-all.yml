name: Delete All AWS Resources

on:
  workflow_dispatch:

jobs:
  delete:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Delete Everything
        run: |
          # Secret
          aws secretsmanager delete-secret --secret-id revivecrm-prod-tekmetric-credentials --force-delete-without-recovery || true
          
          # Tables
          aws dynamodb delete-table --table-name revivecrm-repair-orders-prod || true
          aws dynamodb delete-table --table-name revivecrm-contact-history-prod || true
          aws dynamodb delete-table --table-name revivecrm-appointments-prod || true
          aws dynamodb delete-table --table-name revivecrm-sales-tracking-prod || true
          aws dynamodb delete-table --table-name revivecrm-settings-prod || true
          aws dynamodb delete-table --table-name revivecrm-analytics-cache-prod || true
          
          # Wait for tables
          sleep 30
          
          # IAM - detach policies first
          aws iam list-attached-role-policies --role-name revivecrm-lambda-exec-prod --query 'AttachedPolicies[].PolicyArn' --output text | xargs -n1 aws iam detach-role-policy --role-name revivecrm-lambda-exec-prod --policy-arn || true
          aws iam list-role-policies --role-name revivecrm-lambda-exec-prod --query 'PolicyNames[]' --output text | xargs -n1 aws iam delete-role-policy --role-name revivecrm-lambda-exec-prod --policy-name || true
          aws iam delete-role --role-name revivecrm-lambda-exec-prod || true
          
          aws iam list-attached-role-policies --role-name revivecrm-eventbridge-exec-prod --query 'AttachedPolicies[].PolicyArn' --output text | xargs -n1 aws iam detach-role-policy --role-name revivecrm-eventbridge-exec-prod --policy-arn || true
          aws iam list-role-policies --role-name revivecrm-eventbridge-exec-prod --query 'PolicyNames[]' --output text | xargs -n1 aws iam delete-role-policy --role-name revivecrm-eventbridge-exec-prod --policy-name || true
          aws iam delete-role --role-name revivecrm-eventbridge-exec-prod || true
          
          # S3
          aws s3 rm s3://revivecrm-frontend-prod --recursive || true
          aws s3api delete-bucket --bucket revivecrm-frontend-prod || true
          
          echo "âœ… Everything deleted. Now Terraform can create fresh."
