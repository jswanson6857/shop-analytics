name: One-Time State Migration

on:
  workflow_dispatch:  # Manual trigger ONCE

jobs:
  migrate:
    name: "Import Existing Resources Into State"
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash
        working-directory: terraform
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false
      
      - name: Terraform Init
        run: terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Import All Existing Resources
        run: |
          echo "Importing existing AWS resources into Terraform state..."
          
          terraform import aws_secretsmanager_secret.tekmetric_credentials revivecrm-prod-tekmetric-credentials || echo "Secret not found or already in state"
          terraform import module.backend.aws_dynamodb_table.repair_orders revivecrm-repair-orders-prod || echo "Table not found or already in state"
          terraform import module.backend.aws_dynamodb_table.contact_history revivecrm-contact-history-prod || echo "Table not found or already in state"
          terraform import module.backend.aws_dynamodb_table.appointments revivecrm-appointments-prod || echo "Table not found or already in state"
          terraform import module.backend.aws_dynamodb_table.sales_tracking revivecrm-sales-tracking-prod || echo "Table not found or already in state"
          terraform import module.backend.aws_dynamodb_table.settings revivecrm-settings-prod || echo "Table not found or already in state"
          terraform import module.backend.aws_dynamodb_table.analytics_cache revivecrm-analytics-cache-prod || echo "Table not found or already in state"
          terraform import module.backend.aws_iam_role.lambda_exec revivecrm-lambda-exec-prod || echo "Role not found or already in state"
          terraform import module.backend.aws_iam_role.eventbridge_exec revivecrm-eventbridge-exec-prod || echo "Role not found or already in state"
          terraform import module.frontend.aws_s3_bucket.frontend revivecrm-frontend-prod || echo "Bucket not found or already in state"
          
          echo "Migration complete! State is now in S3."
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Verify State
        run: |
          echo "Resources in state:"
          terraform state list
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Success
        run: |
          echo "✅ Migration complete!"
          echo "✅ State file now in S3"
          echo "✅ Future deploys will work automatically"
          echo ""
          echo "You can now push code and it will deploy!"
